<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Generator klucza NM - PWA</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007bff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="favicon.png">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family: Arial; padding:20px; background:#f5f5f5; }
.day-box, .nm-box { background:white; padding:15px; margin-bottom:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.15);}
input, button { width:100%; margin-bottom:15px; padding:10px; font-size:16px; }
button { background:#007bff; color:white; border:none; border-radius:5px; }
h2,h3{margin-top:0;}
</style>
</head>
<body>

<h1>Generator wyników klucza (±4%)</h1>

<label>Numer urządzenia:</label>
<input type="text" id="deviceNumber" placeholder="np. URZ-5544">

<label>Numer seryjny klucza:</label>
<input type="text" id="snKey" placeholder="np. KD-12345">

<label>Numer seryjny testera:</label>
<input type="text" id="snTester" placeholder="np. TST-99887">

<label>Zakres działania klucza (np. 10-200):</label>
<input type="text" id="range" placeholder="np. 10-200">

<label>Data początkowa:</label>
<input type="date" id="startDate">

<label>Ilość dni:</label>
<input type="number" id="days" value="1" min="1">

<button onclick="generate()">Generuj wyniki</button>

<div id="results"></div>
<button id="pdfButton" style="display:none;" onclick="downloadPDF()">Pobierz PDF</button>

<script>
// --- Funkcje generatora ---
function normalizeRange(value) { return value.replace(/[–—−]/g, "-"); }
function randomWithinError(base) { base=parseFloat(base); const error=base*0.04; const min=base-error; const max=base+error; return (Math.random()*(max-min)+min).toFixed(2);}
function generateNMSection(value){value=parseFloat(value);let html=`<div class="nm-box"><h3>${value} NM</h3>`;html+="<strong>Przed pracą:</strong><br>";for(let i=0;i<5;i++)html+=randomWithinError(value)+" NM<br>";html+="<br><strong>Po pracy:</strong><br>";for(let i=0;i<5;i++)html+=randomWithinError(value)+" NM<br>";html+="</div>";return html;}
function generate(){const deviceNumber=document.getElementById("deviceNumber").value||"Brak";const snKey=document.getElementById("snKey").value||"Brak";const snTester=document.getElementById("snTester").value||"Brak";let rangeInput=document.getElementById("range").value.trim();rangeInput=normalizeRange(rangeInput);const startDate=document.getElementById("startDate").value;const days=parseInt(document.getElementById("days").value);if(!rangeInput.includes("-")){alert("Podaj zakres w formacie np. 10-200");return;}let[minVal,maxVal]=rangeInput.split("-").map(v=>parseFloat(v.trim()));if(isNaN(minVal)||isNaN(maxVal)){alert("Zakres musi być liczbami!");return;}if(maxVal<=minVal){alert("Wartość maksymalna musi być większa od minimalnej.");return;}if(!startDate){alert("Wybierz datę początkową!");return;}const testValues=[maxVal*0.2,maxVal*0.6,maxVal];let currentDate=new Date(startDate);let output="";for(let d=0;d<days;d++){let dateString=currentDate.toLocaleDateString("pl-PL");output+=`<div class="day-box"><h2>Dzień ${d+1} – ${dateString}</h2><strong>Numer urządzenia:</strong> ${deviceNumber}<br><strong>Zakres klucza:</strong> ${minVal}–${maxVal} NM<br><strong>Klucz (SN):</strong> ${snKey}<br><strong>Tester (SN):</strong> ${snTester}<br><br>`;for(let v of testValues)output+=generateNMSection(v);output+="</div>";currentDate.setDate(currentDate.getDate()+1);}document.getElementById("results").innerHTML=output;document.getElementById("pdfButton").style.display="block";}
async function downloadPDF(){const { jsPDF }=window.jspdf;const pdf=new jsPDF({unit:"pt",format:"a4"});await pdf.html(document.getElementById("results"),{callback:function(doc){doc.save("wyniki_klucza.pdf");},margin:[20,20,20,20],html2canvas:{scale:0.55}});}

// --- Service Worker ---
if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js')
    .then(()=>console.log('Service Worker zarejestrowany'))
    .catch(err=>console.log('Błąd SW:', err));
}
</script>

</body>
</html>
